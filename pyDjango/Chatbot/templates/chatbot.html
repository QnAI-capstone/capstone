{% extends 'base.html' %}

{% block styles %}
{% load static %}
<link rel="stylesheet" href="{% static 'chatbot.css' %}">
{% endblock %}

{% block content %}
<div class="chat-container">
  <div class="message-box">
    <ul class="messages-list">
      <!-- ë¡œê·¸ì¸ ì‚¬ìš©ì - chat_history ë¶ˆëŸ¬ì˜¤ê¸° -->
      {% for message in chat_history %}
      {% if message.type == 'date_separator' %}
      <li class="date-separator">ğŸ“… {{ message.date }}</li>
      {% else %}
      <li class="message {% if message.type == 'user' %}sent{% else %}received{% endif %}">
        <div class="message-text">
          <div class="message-sender">
            <b>{% if message.type == 'user' %}ì‚¬ìš©ì{% else %}ì±—ë´‡{% endif %}</b>
          </div>
          <div class="message-content">{{ message.text }}</div>
          <div class="message-time">{{ message.time }}</div>
        </div>
      </li>
      {% endif %}
      {% endfor %}
      <!-- ì˜¤ëŠ˜ ë‚ ì§œ êµ¬ë¶„ì„  í‘œì‹œ -->
      <li class="date-separator">
        ğŸ“… {{ today }}
      </li>
      <!-- ê¸°ë³¸ ì±—ë´‡ ë©”ì‹œì§€ -->
      <li class="message received">
        <div class="message-text">
          <div class="message-sender"><b>ì±—ë´‡</b></div>
          <div class="message-content">ì±—ë´‡ ê¸°ë³¸ ì‘ë‹µ</div>
          <div class="message-time">{{ now }}</div>
        </div>
      </li>
    </ul>
  </div>

  <form class="message-form">
    {%csrf_token%}
    <div class="input-wrapper">
      <input type="text" class="message-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.">
      <button type="submit" class="btn-send">ì „ì†¡</button>
    </div>
  </form>
</div>

<script>
  const messageList = document.querySelector('.messages-list');
  const messageForm = document.querySelector('.message-form');
  const messageInput = document.querySelector('.message-input');

  function formatCurrentTime() {
    const now = new Date();
    return now.getHours().toString().padStart(2, '0') + ':' +
      now.getMinutes().toString().padStart(2, '0');
  }

  function formatTodayDate() {
    const now = new Date();
    return now.getFullYear() + '-' +
      (now.getMonth() + 1).toString().padStart(2, '0') + '-' +
      now.getDate().toString().padStart(2, '0');
  }

  function insertDateIfNeeded() {
    const today = formatTodayDate();
    const lastDate = localStorage.getItem('lastMessageDate');

    if (lastDate !== today) {
      const dateItem = document.createElement('li');
      dateItem.classList.add('date-separator');
      dateItem.textContent = 'ğŸ“… ' + today;
      messageList.appendChild(dateItem);
      localStorage.setItem('lastMessageDate', today);
    }
  }

  messageForm.addEventListener('submit', (event) => {
    event.preventDefault();

    const message = messageInput.value.trim();
    if (message.length === 0) {
      return;
    }

    const time = formatCurrentTime();
    insertDateIfNeeded();  // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ

    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
    const userMessageItem = document.createElement('li');
    userMessageItem.classList.add('message', 'sent');
    userMessageItem.innerHTML = `
      <div class="message-text">
        <div class="message-sender"><b>ì‚¬ìš©ì</b></div>
        <div class="message-content">${message}</div>
        <div class="message-time">${time}</div>
      </div>`;
    messageList.appendChild(userMessageItem);
    messageList.scrollTop = messageList.scrollHeight;

    messageInput.value = '';

    // ì±—ë´‡ ì‘ë‹µ ì²˜ë¦¬
    fetch('', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'message': message
      })
    })
      .then(response => response.json())
      .then(data => {
        const response = data.response;
        const time = formatCurrentTime();

        const botMessageItem = document.createElement('li');
        botMessageItem.classList.add('message', 'received');
        botMessageItem.innerHTML = `
        <div class="message-text">
          <div class="message-sender"><b>ì±—ë´‡</b></div>
          <div class="message-content">${response}</div>
          <div class="message-time">${time}</div>
        </div>`;
        messageList.appendChild(botMessageItem);
        messageList.scrollTop = messageList.scrollHeight;
      });
  });
</script>
{% endblock %}